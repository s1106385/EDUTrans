var month_en=["January","February","March","April","May","June","July","August","September","October","November","December"],timeslot=["00","05","10","15","20","25","30","35","40","45","50","55"],isZH=/\/zh\/{1}/.test(window.location.href),dateFormat=/[\/-]/,specialSchedule={},jsondata={},tdata_to={},tdata_from={},isSatAvailable=0,isSunAvailable=0,fareStaff="",fareStudent="",startEffectDate="",endEffectDate="";function twoDigit(t){return t<10?"0"+t:t}function setPeriod(t){if($(".eta").removeClass("notrip"),isZH){switch(t){case 0:$(".period").text("時間表：星期一至星期五");break;case 1:1===isSatAvailable?$(".period").text("時間表：星期六"):$(".period").text("時間表：N/A (星期六)");break;case 2:1===isSunAvailable?$(".period").text("時間表：星期日"):$(".period").text("時間表：N/A (星期日)");break;case 3:$(".period").text("時間表：N/A (公眾假期 - "+getHolidayDescription(0)+")");break;default:$(".period").text("時間表：N/A")}(1===t&&0===isSatAvailable||2===t&&0===isSunAvailable||3===t)&&$(".eta").addClass("notrip").html(jsondata.info.exceptmsg[isSatAvailable].zh)}else{switch(t){case 0:$(".period").text("Timetable: Monday to Friday");break;case 1:1===isSatAvailable?$(".period").text("Timetable: Saturday"):$(".period").text("Timetable: N/A (Saturday)");break;case 2:1===isSunAvailable?$(".period").text("Timetable: Sunday"):$(".period").text("Timetable: N/A (Sunday)");break;case 3:$(".period").text("Timetable: N/A (Public Holiday - "+getHolidayDescription(1)+")");break;default:$(".period").text("Timetable: N/A")}(1===t&&0===isSatAvailable||2===t&&0===isSunAvailable||3===t)&&$(".eta").addClass("notrip").html(jsondata.info.exceptmsg[isSatAvailable].en)}}function loadTimetable(t,e){if(appendString="",/.sat/.test(e)&&1===isSatAvailable?isZH?$(e).html('<tr><th colspan="13">星期六</th></tr>'):$(e).html('<tr><th colspan="13">Saturdays</th></tr>'):/.sun/.test(e)&&1===isSunAvailable?isZH?$(e).html('<tr><th colspan="13">星期日</th></tr>'):$(e).html('<tr><th colspan="13">Sundays</th></tr>'):isZH?$(e).html('<tr><th colspan="13">星期一至五</th></tr>'):$(e).html('<tr><th colspan="13">Mondays to Fridays</th></tr>'),appendString+=isZH?'<tr><th>時</th><th colspan="12">分</th></tr>':'<tr><th>Hour</th><th colspan="12">Minute</th></tr>',void 0!==t){for(i=0;i<t.objlength;i++){for(appendString+="<tr><th>"+twoDigit(parseInt(t.timetable[i].hour))+"</th>",k=0,j=0;j<timeslot.length;j++)k<t.timetable[i].minute.length&&t.timetable[i].minute[k].t==timeslot[j]?(appendString+="<td class='exist",t.timetable[i].minute[k].blkd&&(appendString+=" blk"),"NA"!==t.timetable[i].minute[k].st&&(appendString+=" special"),appendString+="'","NA"!==t.timetable[i].minute[k].st&&(appendString+=" data-specialtrip="+t.timetable[i].minute[k].st),appendString+=">"+timeslot[j]+"</td>",k++):appendString+="<td>"+timeslot[j]+"</td>";appendString+="</tr>"}$(e).append(appendString);var a,d=0;for(a in specialSchedule)specialSchedule.hasOwnProperty(a)&&($(".timetable td[data-specialtrip='"+d+"']").css("background-color",specialSchedule[d].color),d++)}}function fetchTimetable(t,e){var a={objlength:0,timetable:[]},d=0;for(i=0;i<e.length;i++)for(mins=e[i].minute,j=e[i].hour.from;j<=e[i].hour.to;j++){for(a.timetable[d]={hour:j,minute:[]},k=0;k<mins.length;k++)a.timetable[d].minute[k]={t:mins[k].t,st:mins[k].st,blkd:mins[k].blkd};d++}return a.objlength=d,a}function loadETAList(t,e,a,i){return appendString="<div>","NA"!==e?(appendString+="<div class='special' data-specialtrip='"+e+"'>•</div>"+t,appendString+=isZH?" 額外班次":" Additional Trip"):appendString+=t,i&&(appendString+=isZH?" 尾班車":" Last shuttle"),a&&(appendString+="<div class='blk'>D</div>"),appendString+="</div>",appendString}function getNextBusTime(t,e){if(void 0!==t)if(date=new Date,hh=date.getHours(),mm=date.getMinutes(),firstHour=parseInt(t.timetable[0].hour),index=hh-firstHour,(/to/.test(e)?$("div.eta.to"):$("div.eta.from")).html(""),hh>=firstHour&&hh<=t.timetable[t.objlength-1].hour)for(minindex=0,i=0;i<3;i++){if(time="",lastbus=!1,index>=t.objlength){/to/.test(e)?($("table.eta.to tr:last-child td:last-child").text("N/A"),isZH?$("div.eta.to").append("<div>尾班車經已開出</div>"):$("div.eta.to").append("<div>Last shuttle has been departed</div>")):($("table.eta.from tr:last-child td:last-child").text("N/A"),isZH?$("div.eta.from").append("<div>尾班車經已開出</div>"):$("div.eta.from").append("<div>Last shuttle has been departed</div>"));break}if(hh===t.timetable[index].hour&&mm>parseInt(t.timetable[index].minute[t.timetable[index].minute.length-1].t)){if(!(index+1<t.objlength)){/to/.test(e)?($("table.eta.to tr:last-child td:last-child").text("N/A"),isZH?$("div.eta.to").append("<div>尾班車已經開出</div>"):$("div.eta.to").append("<div>Last shuttle has been departed</div>")):($("table.eta.from tr:last-child td:last-child").text("N/A"),isZH?$("div.eta.from").append("<div>尾班車已經開出</div>"):$("div.eta.from").append("<div>Last shuttle has been departed</div>"));break}index++,hh=t.timetable[index].hour,mm=parseInt(t.timetable[index].minute[0].t)+1,"NA"===t.timetable[index].minute[0].st||specialSchedule[t.timetable[index].minute[0].st].isToday?(time=twoDigit(parseInt(t.timetable[index].hour))+":"+t.timetable[index].minute[0].t,0===i&&$(e).children("div.time").text(time),hh==t.timetable[index].hour&&t.timetable[index].minute.length<=1&&(lastbus=!0),(/to/.test(e)?$("div.eta.to"):$("div.eta.from")).append(loadETAList(time,t.timetable[index].minute[0].st,t.timetable[index].minute[0].blkd,lastbus)),minindex=1):i--}else if(hh===t.timetable[index].hour&&mm<=parseInt(t.timetable[index].minute[t.timetable[index].minute.length-1].t))for(k=minindex;k<t.timetable[index].minute.length;k++)mm<=parseInt(t.timetable[index].minute[k].t)&&(mm=parseInt(t.timetable[index].minute[k].t)+1,"NA"===t.timetable[index].minute[k].st||specialSchedule[t.timetable[index].minute[k].st].isToday?(time=twoDigit(parseInt(t.timetable[index].hour))+":"+t.timetable[index].minute[k].t,0===i&&$(e).children("div.time").text(time),index==t.objlength-1&&k+1>=t.timetable[index].minute.length&&(lastbus=!0),(/to/.test(e)?$("div.eta.to"):$("div.eta.from")).append(loadETAList(time,t.timetable[index].minute[k].st,t.timetable[index].minute[k].blkd,lastbus))):i--,k=999),minindex++;else alert(hh+" "+t.timetable[index].hour+" "+mm+" "+t.timetable[index].minute[minindex].t)}else/to/.test(e)?($("table.eta.to tr:last-child td:last-child").text("N/A"),isZH?$("div.eta.to").append("<div>本小時沒有班次，詳情請查閱時間表</div>"):$("div.eta.to").append("<div>No shuttle in this hour, please refer Timetable for details</div>")):($("table.eta.from tr:last-child td:last-child").text("N/A"),isZH?$("div.eta.from").append("<div>本小時沒有班次，詳情請查閱時間表</div>"):$("div.eta.from").append("<div>No shuttle in this hour, please refer Timetable for details</div>"))}$(document).ready(function(){date=new Date,sdate=[],year=date.getFullYear(),month=date.getMonth()+1,day=date.getDate(),checkday=new RegExp(date.getDay()),url="https://s1106385.github.io/json/cycle.json?rd="+date.getTime(),daystate=getDayState(),$.get(url,function(t){if(void 0===t.cycle||null===t.cycle)return!1;for(jsondata=t.cycle,isSatAvailable=jsondata.info.issatavailable,isSunAvailable=jsondata.info.issunavailable,fareStaff=jsondata.info.fare.staff,fareStudent=jsondata.info.fare.student,startEffectDate=[jsondata.info.effdate.start.year,jsondata.info.effdate.start.month,jsondata.info.effdate.start.date],endEffectDate=[jsondata.info.effdate.end.year,jsondata.info.effdate.end.month,jsondata.info.effdate.end.date],tdata_to[0]=fetchTimetable("tocampus",jsondata.timetable.weekday.tocampus),tdata_from[0]=fetchTimetable("fromcampus",jsondata.timetable.weekday.fromcampus),loadTimetable(tdata_to[0],".timetable.normal.to"),loadTimetable(tdata_from[0],".timetable.normal.from"),1===isSatAvailable&&(tdata_to[1]=fetchTimetable("tocampus",jsondata.timetable.saturday.tocampus),tdata_from[1]=fetchTimetable("fromcampus",jsondata.timetable.saturday.fromcampus),loadTimetable(tdata_to[1],".timetable.sat.to"),loadTimetable(tdata_from[1],".timetable.sat.from")),1===isSunAvailable&&(tdata_to[2]=fetchTimetable("tocampus",jsondata.timetable.sunday.tocampus),loadTimetable(tdata_to[2],".timetable.sun.to"),loadTimetable(tdata_from[2],".timetable.sun.from")),nthchild=1,i=0;i<jsondata.specialtrip.length;i++){for(specialinfo=jsondata.specialtrip[i],specialSchedule[i]={isTody:!1,color:specialinfo.color,day:specialinfo.day},k=0;k<specialinfo.period.length;k++)sdate=specialinfo.period[k].date.split(dateFormat),(month>sdate[1]||parseInt(sdate[1])===month&&day>=sdate[0]&&(month<sdate[3]||parseInt(sdate[3])===month&&day<=sdate[2]))&&(specialSchedule[i].isToday=!0);checkday.test(specialSchedule[i].day)||(specialSchedule[i].isToday=!1),$("ol.notes li:nth-child("+nthchild+++")").after("<li class='special' data-specialtrip='"+i+"'></li>"),$("head").append("<style>li[data-specialtrip='"+i+"']:before{color: "+specialSchedule[i].color+";}</style>"),$("head").append("<style>.timetable td[data-specialtrip='"+i+"']{background-color:"+specialSchedule[i].color+";}</style>"),$("head").append("<style>.eta div div[data-specialtrip='"+i+"']{color:"+specialSchedule[i].color+";}</style>"),isZH?$("li[data-specialtrip='"+i+"']").html(specialinfo.description.zh):$("li[data-specialtrip='"+i+"']").html(specialinfo.description.en),$("li[data-specialtrip='"+i+"']").show()}setPeriod(daystate),3!==daystate&&(getNextBusTime(tdata_to[daystate],".nextbus.tocampus"),getNextBusTime(tdata_from[daystate],".nextbus.fromcampus")),setInterval(function(){if($(".nextbus.tocampus").children("div.time").css("color","#1F1F21"),$(".nextbus.fromcampus").children("div.time").css("color","#1F1F21"),daystate!==getDayState())for(daystate=getDayState(),setPeriod(daystate),i=0;i<jsondata.specialtrip.length;i++)for(k=0;k<jsondata.specialtrip[i].period.length;k++)sdate=jsondata.specialtrip[i].period[k].date.split(dateFormat),(month>sdate[1]||parseInt(sdate[1])===month&&day>=sdate[0]&&(month<sdate[3]||parseInt(sdate[3])===month&&day<=sdate[2]))&&(specialSchedule[i].isToday=!0);3!==daystate&&(getNextBusTime(tdata_to[daystate],".nextbus.tocampus"),getNextBusTime(tdata_from[daystate],".nextbus.fromcampus"))},1e4),isZH?($(".effDate").text("資料有效期："+startEffectDate[0]+"年"+startEffectDate[1]+"月"+startEffectDate[2]+"日 至 "+endEffectDate[0]+"年"+endEffectDate[1]+"月"+endEffectDate[2]+"日"),$(".fare").text("車資：教職員 $"+fareStaff+"；學生 $"+fareStudent)):($(".effDate").text("Effective from "+startEffectDate[2]+" "+month_en[parseInt(startEffectDate[1])-1]+" "+startEffectDate[0]+" to "+endEffectDate[2]+" "+month_en[parseInt(endEffectDate[1])-1]+" "+endEffectDate[0]),$(".fare").text("Fare: Staff $"+fareStaff+"; Students $"+fareStudent))},"json"),$(".timetable.tocampus").on("click",function(){$(".timetable.to").slideToggle("fast")}),$(".timetable.fromcampus").on("click",function(){$(".timetable.from").slideToggle("fast")}),$(".nextbus.tocampus").on("click",function(){$("div.eta.to").slideToggle("fast")}),$(".nextbus.fromcampus").on("click",function(){$("div.eta.from").slideToggle("fast")}),$("div.timetable").css("left",-$("div.timetable").outerWidth()),$("#shuttlettb").on("click",function(){$(".navbar nav").removeClass("active"),$(this).addClass("active"),0===parseInt($("div.etashuttle").css("left"),10)&&($("div.timetable").show(),$("div.timetable").animate({left:0}),$("div.etashuttle").animate({left:$("div.etashuttle").outerWidth()},function(){$("div.etashuttle").hide()}))}),$("#shuttleeta").on("click",function(){$(".navbar nav").removeClass("active"),$(this).addClass("active"),0!==parseInt($("div.etashuttle").css("left"),10)&&($("div.etashuttle").show(),$("div.timetable").animate({left:-$("div.timetable").outerWidth()}),$("div.etashuttle").animate({left:0},function(){$("div.timetable").hide()}))})});